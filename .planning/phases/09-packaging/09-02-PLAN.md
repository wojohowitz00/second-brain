---
phase: 09-packaging
plan: 02
type: implementation
wave: 2
depends_on: ["09-01"]
files_modified:
  - scripts/build_pkg.sh
  - resources/com.secondbrain.app.plist
  - scripts/install_launchagent.sh
  - scripts/uninstall.sh
autonomous: true

must_haves:
  truths:
    - ".pkg installer created from .app bundle"
    - "Installer places app in /Applications"
    - "LaunchAgent plist available for login startup"
    - "Install/uninstall scripts work correctly"
  artifacts:
    - path: "scripts/build_pkg.sh"
      provides: "Script to create .pkg installer"
      min_lines: 30
    - path: "resources/com.secondbrain.app.plist"
      provides: "LaunchAgent for login startup"
      min_lines: 15
    - path: "scripts/install_launchagent.sh"
      provides: "Script to enable launch on login"
      min_lines: 15
    - path: "scripts/uninstall.sh"
      provides: "Script to remove app and LaunchAgent"
      min_lines: 20
---

<objective>
Create .pkg installer from .app bundle and LaunchAgent for optional login startup.

Purpose: Provide professional distribution package that installs to /Applications and optionally starts on login.

Output: .pkg installer, LaunchAgent plist, install/uninstall scripts.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/09-packaging/09-RESEARCH.md
@.planning/phases/09-packaging/09-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .pkg build script</name>
  <files>scripts/build_pkg.sh</files>
  <action>
    Create scripts/build_pkg.sh:

    ```bash
    #!/bin/bash
    # Build Second Brain .pkg installer from .app bundle
    set -e

    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
    VERSION="1.0.0"
    APP_NAME="Second Brain"
    IDENTIFIER="com.secondbrain.app"

    cd "$PROJECT_DIR"

    echo "=== Building Second Brain.pkg ==="

    # Check if .app bundle exists
    if [ ! -d "dist/${APP_NAME}.app" ]; then
        echo "Error: dist/${APP_NAME}.app not found"
        echo "Run ./scripts/build_app.sh first"
        exit 1
    fi

    # Create pkg output directory
    mkdir -p pkg

    # Build .pkg installer using pkgbuild
    echo "Creating .pkg installer..."
    pkgbuild \
        --root "dist/" \
        --identifier "$IDENTIFIER" \
        --version "$VERSION" \
        --install-location "/Applications" \
        "pkg/SecondBrain-${VERSION}.pkg"

    if [ -f "pkg/SecondBrain-${VERSION}.pkg" ]; then
        echo ""
        echo "✓ Built: pkg/SecondBrain-${VERSION}.pkg"
        echo ""
        echo "To install: open pkg/SecondBrain-${VERSION}.pkg"
        echo "Or: sudo installer -pkg pkg/SecondBrain-${VERSION}.pkg -target /"
    else
        echo "✗ Build failed"
        exit 1
    fi
    ```
  </action>
  <verify>
    ```bash
    chmod +x /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/scripts/build_pkg.sh
    ls -la /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/scripts/build_pkg.sh
    ```
  </verify>
  <done>build_pkg.sh created and executable</done>
</task>

<task type="auto">
  <name>Task 2: Create LaunchAgent plist</name>
  <files>resources/com.secondbrain.app.plist</files>
  <action>
    Create resources/com.secondbrain.app.plist:

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>Label</key>
        <string>com.secondbrain.app</string>
        
        <key>ProgramArguments</key>
        <array>
            <string>/Applications/Second Brain.app/Contents/MacOS/Second Brain</string>
        </array>
        
        <key>RunAtLoad</key>
        <true/>
        
        <key>KeepAlive</key>
        <false/>
        
        <key>StandardOutPath</key>
        <string>/tmp/secondbrain.out.log</string>
        
        <key>StandardErrorPath</key>
        <string>/tmp/secondbrain.err.log</string>
    </dict>
    </plist>
    ```
  </action>
  <verify>
    ```bash
    plutil -lint /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/resources/com.secondbrain.app.plist
    ```
  </verify>
  <done>LaunchAgent plist created and valid</done>
</task>

<task type="auto">
  <name>Task 3: Create LaunchAgent install script</name>
  <files>scripts/install_launchagent.sh</files>
  <action>
    Create scripts/install_launchagent.sh:

    ```bash
    #!/bin/bash
    # Install Second Brain LaunchAgent for login startup
    set -e

    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
    PLIST_NAME="com.secondbrain.app.plist"
    LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"

    echo "=== Installing Second Brain LaunchAgent ==="

    # Check if app is installed
    if [ ! -d "/Applications/Second Brain.app" ]; then
        echo "Error: Second Brain.app not found in /Applications"
        echo "Please install the app first"
        exit 1
    fi

    # Create LaunchAgents directory if needed
    mkdir -p "$LAUNCH_AGENTS_DIR"

    # Copy plist
    cp "$PROJECT_DIR/resources/$PLIST_NAME" "$LAUNCH_AGENTS_DIR/"

    # Load the agent
    launchctl load "$LAUNCH_AGENTS_DIR/$PLIST_NAME" 2>/dev/null || true

    echo "✓ LaunchAgent installed"
    echo "Second Brain will now start automatically on login"
    echo ""
    echo "To disable: ./scripts/uninstall.sh --launchagent-only"
    ```
  </action>
  <verify>
    ```bash
    chmod +x /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/scripts/install_launchagent.sh
    ```
  </verify>
  <done>install_launchagent.sh created</done>
</task>

<task type="auto">
  <name>Task 4: Create uninstall script</name>
  <files>scripts/uninstall.sh</files>
  <action>
    Create scripts/uninstall.sh:

    ```bash
    #!/bin/bash
    # Uninstall Second Brain
    set -e

    PLIST_NAME="com.secondbrain.app.plist"
    LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"
    APP_PATH="/Applications/Second Brain.app"

    echo "=== Uninstalling Second Brain ==="

    # Parse arguments
    LAUNCHAGENT_ONLY=false
    if [ "$1" = "--launchagent-only" ]; then
        LAUNCHAGENT_ONLY=true
    fi

    # Unload and remove LaunchAgent
    if [ -f "$LAUNCH_AGENTS_DIR/$PLIST_NAME" ]; then
        echo "Removing LaunchAgent..."
        launchctl unload "$LAUNCH_AGENTS_DIR/$PLIST_NAME" 2>/dev/null || true
        rm -f "$LAUNCH_AGENTS_DIR/$PLIST_NAME"
        echo "✓ LaunchAgent removed"
    fi

    # Remove app if not launchagent-only
    if [ "$LAUNCHAGENT_ONLY" = false ]; then
        if [ -d "$APP_PATH" ]; then
            echo "Removing application..."
            rm -rf "$APP_PATH"
            echo "✓ Application removed"
        fi
        
        # Remove state files
        STATE_DIR="$HOME/.secondbrain"
        if [ -d "$STATE_DIR" ]; then
            echo "Removing state files..."
            rm -rf "$STATE_DIR"
            echo "✓ State files removed"
        fi
    fi

    echo ""
    echo "Second Brain has been uninstalled"
    ```
  </action>
  <verify>
    ```bash
    chmod +x /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/scripts/uninstall.sh
    ```
  </verify>
  <done>uninstall.sh created</done>
</task>

</tasks>

<verification>
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain

# Verify all files exist and are executable
test -x scripts/build_pkg.sh && echo "✓ build_pkg.sh"
test -f resources/com.secondbrain.app.plist && echo "✓ LaunchAgent plist"
test -x scripts/install_launchagent.sh && echo "✓ install_launchagent.sh"
test -x scripts/uninstall.sh && echo "✓ uninstall.sh"

# Validate plist
plutil -lint resources/com.secondbrain.app.plist

# Build .pkg (requires .app from 09-01)
# ./scripts/build_pkg.sh
```
</verification>

<success_criteria>
1. build_pkg.sh creates .pkg from .app bundle
2. LaunchAgent plist is valid XML
3. install_launchagent.sh enables login startup
4. uninstall.sh removes app and LaunchAgent
5. .pkg installs app to /Applications
</success_criteria>

<output>
After completion, create `.planning/phases/09-packaging/09-02-SUMMARY.md`
</output>
