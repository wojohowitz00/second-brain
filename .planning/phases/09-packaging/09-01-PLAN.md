---
phase: 09-packaging
plan: 01
type: implementation
wave: 1
depends_on: ["07-menu-bar-interface"]
files_modified:
  - setup.py
  - scripts/build_app.sh
autonomous: true

must_haves:
  truths:
    - "py2app builds .app bundle from menu_bar_app.py"
    - "Bundle includes all Python dependencies (rumps, ollama, requests)"
    - "Bundle includes all local modules (menu_bar_app, notifications, etc.)"
    - "App runs standalone without Python environment"
    - "Menu bar icon appears when launching .app bundle"
  artifacts:
    - path: "setup.py"
      provides: "py2app configuration for macOS app bundle"
      min_lines: 40
    - path: "scripts/build_app.sh"
      provides: "Build script for .app bundle"
      min_lines: 20
  key_links:
    - from: "setup.py"
      to: "backend/_scripts/menu_bar_app.py"
      via: "APP entry point"
      pattern: "APP = ['menu_bar_app.py']"
---

<objective>
Create py2app configuration and build script to generate standalone .app bundle for Second Brain menu bar application.

Purpose: Package the Python application as a native macOS app that users can run without installing Python.

Output: setup.py with py2app config, build script, and verified .app bundle.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-packaging/09-RESEARCH.md
@backend/_scripts/menu_bar_app.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup.py with py2app configuration</name>
  <files>setup.py</files>
  <action>
    Create setup.py at project root with py2app configuration:

    ```python
    """
    py2app build configuration for Second Brain menu bar app.
    
    Build with: python setup.py py2app
    Output: dist/Second Brain.app
    """
    from setuptools import setup

    APP = ['backend/_scripts/menu_bar_app.py']
    DATA_FILES = []
    
    OPTIONS = {
        'argv_emulation': False,
        'iconfile': None,  # TODO: Add icon file if available
        'plist': {
            'LSUIElement': True,  # Hide from dock (menu bar app)
            'CFBundleName': 'Second Brain',
            'CFBundleDisplayName': 'Second Brain',
            'CFBundleIdentifier': 'com.secondbrain.app',
            'CFBundleVersion': '1.0.0',
            'CFBundleShortVersionString': '1.0.0',
            'NSHighResolutionCapable': True,
            'NSHumanReadableCopyright': 'Copyright Â© 2026',
        },
        'packages': [
            'rumps',
            'ollama',
            'requests',
            'certifi',
            'urllib3',
            'charset_normalizer',
            'idna',
        ],
        'includes': [
            # Local modules
            'menu_bar_app',
            'notifications',
            'process_inbox',
            'message_classifier',
            'ollama_client',
            'vault_scanner',
            'slack_client',
            'file_writer',
            'state',
            'schema',
            'wikilinks',
            'fix_handler',
            'status_handler',
            'task_parser',
        ],
        'excludes': [
            'test',
            'tests',
            'pytest',
        ],
        'site_packages': True,
    }

    setup(
        name='Second Brain',
        app=APP,
        data_files=DATA_FILES,
        options={'py2app': OPTIONS},
        setup_requires=['py2app'],
    )
    ```
  </action>
  <verify>
    ```bash
    cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain
    python -c "import setup; print('setup.py valid')"
    ```
  </verify>
  <done>setup.py created with full py2app configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create build script</name>
  <files>scripts/build_app.sh</files>
  <action>
    Create scripts/build_app.sh:

    ```bash
    #!/bin/bash
    # Build Second Brain .app bundle using py2app
    set -e

    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
    
    cd "$PROJECT_DIR"

    echo "=== Building Second Brain.app ==="

    # Clean previous builds
    echo "Cleaning previous builds..."
    rm -rf build dist

    # Ensure py2app is installed
    echo "Installing py2app..."
    pip install py2app

    # Add _scripts to Python path for imports
    export PYTHONPATH="$PROJECT_DIR/backend/_scripts:$PYTHONPATH"

    # Build .app bundle
    echo "Building .app bundle..."
    python setup.py py2app

    # Verify bundle exists
    if [ -d "dist/Second Brain.app" ]; then
        echo "âœ“ Built: dist/Second Brain.app"
        echo ""
        echo "To test: open 'dist/Second Brain.app'"
    else
        echo "âœ— Build failed - no .app bundle created"
        exit 1
    fi
    ```
  </action>
  <verify>
    ```bash
    chmod +x /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/scripts/build_app.sh
    ls -la /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/scripts/build_app.sh
    ```
  </verify>
  <done>Build script created and executable</done>
</task>

<task type="manual">
  <name>Task 3: Build and test .app bundle</name>
  <files>dist/Second Brain.app</files>
  <action>
    Run the build script and verify the app works:

    ```bash
    cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain
    ./scripts/build_app.sh
    
    # Test the built app
    open "dist/Second Brain.app"
    ```

    Verify:
    1. App launches without Python visible
    2. Menu bar icon (ðŸ§ ) appears
    3. Menu opens with Sync Now, Recent Activity, Quit
    4. No crash on launch
  </action>
  <verify>
    Manual verification that .app bundle runs correctly.
  </verify>
  <done>App bundle builds and runs standalone</done>
</task>

</tasks>

<verification>
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain

# Verify setup.py exists
test -f setup.py && echo "âœ“ setup.py exists"

# Verify build script exists and is executable
test -x scripts/build_app.sh && echo "âœ“ build script executable"

# Run build (if not already done)
./scripts/build_app.sh

# Verify .app bundle
test -d "dist/Second Brain.app" && echo "âœ“ .app bundle created"
```
</verification>

<success_criteria>
1. setup.py created with py2app configuration
2. build_app.sh script created and executable
3. `python setup.py py2app` completes without errors
4. dist/Second Brain.app exists after build
5. .app launches and shows menu bar icon
</success_criteria>

<output>
After completion, create `.planning/phases/09-packaging/09-01-SUMMARY.md`
</output>
