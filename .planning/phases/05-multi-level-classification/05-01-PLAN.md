---
phase: 05-multi-level-classification
plan: 01
type: tdd
wave: 1
depends_on: ["03-ollama-connection", "02-vault-scanner"]
files_modified:
  - backend/_scripts/message_classifier.py
  - backend/tests/test_message_classifier.py
autonomous: true

must_haves:
  truths:
    - "Given a message, app returns domain, PARA type, subject, and category"
    - "Classification uses vault vocabulary from VaultScanner"
    - "Invalid/unexpected LLM responses normalize to valid defaults"
    - "Classification completes within 30s (cold) or 5s (warm)"
    - "Confidence score between 0.0 and 1.0"
  artifacts:
    - path: "backend/_scripts/message_classifier.py"
      provides: "MessageClassifier for full classification pipeline"
      min_lines: 150
      exports: ["MessageClassifier", "classify_message", "ClassificationResult"]
    - path: "backend/tests/test_message_classifier.py"
      provides: "Unit tests for multi-level classification"
      min_lines: 150
  key_links:
    - from: "backend/_scripts/message_classifier.py"
      to: "backend/_scripts/ollama_client.py"
      via: "import"
      pattern: "from ollama_client import"
    - from: "backend/_scripts/message_classifier.py"
      to: "backend/_scripts/vault_scanner.py"
      via: "import"
      pattern: "from vault_scanner import"
---

<objective>
Create a MessageClassifier that uses local LLM (via OllamaClient) to classify messages into four levels: domain, PARA type, subject, and category, using vocabulary from VaultScanner.

Purpose: Complete classification pipeline for organizing Slack messages into Obsidian vault structure.

Output: MessageClassifier.classify(message) → ClassificationResult with domain, para_type, subject, category, confidence, and reasoning.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-multi-level-classification/05-RESEARCH.md
@backend/_scripts/ollama_client.py
@backend/_scripts/vault_scanner.py
</context>

<feature>
  <name>MessageClassifier</name>
  <files>
    backend/_scripts/message_classifier.py
    backend/tests/test_message_classifier.py
  </files>
  <behavior>
    Single-shot classification of messages into four levels:

    Input: "Review Q4 financials for Just Value Newark properties"
    Output: ClassificationResult(
        domain="Just-Value",
        para_type="2_Areas",
        subject="properties",
        category="task",
        confidence=0.85,
        reasoning="Financial review task for Just Value real estate"
    )

    Available vocabulary from VaultScanner:
    - Domains: Personal, Just-Value, CCBH
    - PARA: 1_Projects, 2_Areas, 3_Resources, 4_Archive
    - Subjects: apps, writing, clients, properties, etc.
    - Categories: meeting, task, idea, reference, journal, question

    Test cases (TDD - write tests FIRST):

    ## Domain Classification (folding Phase 4)
    1. Personal task message → domain="Personal"
    2. Just-Value property message → domain="Just-Value"
    3. CCBH work message → domain="CCBH"
    4. Unknown domain in response → normalize to "Personal"

    ## PARA Classification
    5. Project-related message → para_type="1_Projects"
    6. Ongoing area message → para_type="2_Areas"
    7. Reference info message → para_type="3_Resources"
    8. Historical/archived message → para_type="4_Archive"
    9. Invalid PARA → normalize to "3_Resources"

    ## Subject Classification
    10. Message about apps → subject="apps" (from vocabulary)
    11. Message about unknown topic → subject="general"
    12. Subject exists only in certain domain/PARA → validate hierarchy

    ## Category Classification
    13. Meeting notes → category="meeting"
    14. Action item → category="task"
    15. Brainstorm → category="idea"
    16. Info to save → category="reference"
    17. Invalid category → normalize to "reference"

    ## Validation & Edge Cases
    18. Valid JSON response → parse correctly
    19. Invalid JSON → regex fallback
    20. Empty message → return defaults with low confidence
    21. LLM timeout → raise OllamaTimeout
    22. LLM not running → raise OllamaServerNotRunning
    23. Confidence always 0.0-1.0

  </behavior>
  <implementation>
    Create message_classifier.py with:

    1. VALID_CATEGORIES constant:
       ["meeting", "task", "idea", "reference", "journal", "question"]

    2. DEFAULT_PARA_TYPE = "3_Resources"
       DEFAULT_CATEGORY = "reference"
       DEFAULT_SUBJECT = "general"

    3. ClassificationResult dataclass:
       - domain: str
       - para_type: str
       - subject: str
       - category: str
       - confidence: float
       - reasoning: str
       - raw_response: Optional[str] = None

    4. MessageClassifier class:
       - __init__(ollama_client=None, vault_scanner=None)
       - classify(message: str) -> ClassificationResult
       - _build_prompt(message: str, vocabulary: dict) -> str
       - _parse_response(response: str, vocabulary: dict) -> ClassificationResult
       - _validate_domain(domain: str, valid_domains: list) -> str
       - _validate_para(para: str) -> str
       - _validate_subject(subject: str, structure: dict, domain: str, para: str) -> str
       - _validate_category(category: str) -> str

    5. Prompt template:
       ```
       You are a classification assistant for a personal knowledge management system.

       VOCABULARY (use ONLY these values):
       Domains: {domains}
       PARA Types: 1_Projects, 2_Areas, 3_Resources, 4_Archive
       Categories: meeting, task, idea, reference, journal, question

       SUBJECTS by domain:
       {subjects_by_domain}

       MESSAGE TO CLASSIFY:
       "{message}"

       Respond with ONLY this JSON (no other text):
       {"domain": "...", "para_type": "...", "subject": "...", "category": "...", "confidence": 0.0-1.0, "reasoning": "..."}
       ```

    6. Response parsing:
       - json.loads() first
       - If fails, regex: r'"(\w+)":\s*"?([^",}]+)"?'
       - Validate each field against vocabulary
       - Normalize invalid values to defaults

    7. Convenience function:
       - classify_message(message: str) -> ClassificationResult
         Uses default OllamaClient() and VaultScanner()

    Handle all OllamaClient exceptions (OllamaServerNotRunning, OllamaTimeout, OllamaModelNotFound).
  </implementation>
</feature>

<verification>
Run tests with verbose output:
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run pytest tests/test_message_classifier.py -v --tb=short
```

Manual verification (requires Ollama running):
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run python -c "
import sys
sys.path.insert(0, '_scripts')
from message_classifier import classify_message

# Test full classification
messages = [
    'Need to set up my home office workspace',
    'Review Q4 rental income for Newark properties',
    'Meeting with CCBH board next Tuesday',
    'Great idea for the new app feature'
]

for msg in messages:
    result = classify_message(msg)
    print(f'{msg[:40]}...')
    print(f'  → {result.domain}/{result.para_type}/{result.subject} [{result.category}]')
    print(f'  Confidence: {result.confidence:.0%}')
    print()
"
```
</verification>

<success_criteria>
1. Tests written FIRST, fail initially (RED phase)
2. MessageClassifier.classify() returns ClassificationResult with all 4 levels
3. Each field validated against vocabulary or defaults
4. Confidence between 0.0 and 1.0
5. Reasoning explains classification
6. Handles LLM errors gracefully
7. At least 20 test cases covering all classification levels and error handling
8. `uv run pytest tests/test_message_classifier.py -v` exits with code 0
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-level-classification/05-01-SUMMARY.md`
</output>
