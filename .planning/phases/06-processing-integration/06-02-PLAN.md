---
phase: 06-processing-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/_scripts/process_inbox.py
autonomous: true

must_haves:
  truths:
    - "process_message() calls MessageClassifier.classify() instead of classify_thought()"
    - "process_message() calls create_note_file() with classification result"
    - "Messages are classified with 4-level classification (domain/para/subject/category)"
    - "Files are created in domain/para_type/subject/ folder structure"
  artifacts:
    - path: "backend/_scripts/process_inbox.py"
      provides: "Refactored message processor using MessageClassifier"
      contains: "from message_classifier import MessageClassifier"
  key_links:
    - from: "backend/_scripts/process_inbox.py"
      to: "backend/_scripts/message_classifier.py"
      via: "import MessageClassifier"
      pattern: "from message_classifier import"
    - from: "backend/_scripts/process_inbox.py"
      to: "backend/_scripts/file_writer.py"
      via: "import create_note_file"
      pattern: "from file_writer import"
---

<objective>
Refactor process_inbox.py to use MessageClassifier for 4-level classification and file_writer for PARA-aware file creation.

Purpose: Wire together the classification pipeline with the file creation module, replacing the placeholder classify_thought() and old write_to_obsidian() functions.

Output: Updated process_inbox.py that classifies messages and creates files in the correct vault locations.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-processing-integration/06-RESEARCH.md
@.planning/phases/06-processing-integration/06-01-SUMMARY.md
@backend/_scripts/process_inbox.py
@backend/_scripts/message_classifier.py
@backend/_scripts/file_writer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update imports and constants</name>
  <files>backend/_scripts/process_inbox.py</files>
  <action>
    Update imports in process_inbox.py:
    - Add: `from message_classifier import MessageClassifier, ClassificationResult`
    - Add: `from file_writer import create_note_file`
    - Update VAULT_PATH to point to ~/PARA (matching vault_scanner.py)
    - Remove or comment out the old CLASSIFICATION_PROMPT constant (no longer needed)
    - Remove or comment out the old classify_thought() function (replaced by MessageClassifier)
  </action>
  <verify>
    ```bash
    cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend/_scripts
    python -c "from process_inbox import MessageClassifier, create_note_file; print('Imports OK')"
    ```
  </verify>
  <done>process_inbox.py imports MessageClassifier and create_note_file without errors</done>
</task>

<task type="auto">
  <name>Task 2: Refactor process_message() to use new classification</name>
  <files>backend/_scripts/process_inbox.py</files>
  <action>
    Refactor the process_message() function:

    1. Create MessageClassifier instance at module level (lazy initialization):
       ```python
       _classifier: Optional[MessageClassifier] = None

       def get_classifier() -> MessageClassifier:
           global _classifier
           if _classifier is None:
               _classifier = MessageClassifier()
           return _classifier
       ```

    2. Replace the classification block in process_message():
       OLD:
       ```python
       raw_classification = classify_thought(text)
       classification = validate_classification(raw_classification)
       ```
       NEW:
       ```python
       classifier = get_classifier()
       result = classifier.classify(text)
       ```

    3. Update file creation to use file_writer:
       OLD: `filepath = write_to_obsidian(classification, text, timestamp)`
       NEW: `filepath = create_note_file(result, text, VAULT_PATH)`

    4. Update the confidence check: `result.confidence >= 0.6`

    5. Update the reply message to reflect new classification structure:
       ```python
       reply_to_message(
           ts,
           f"âœ“ Filed to *{result.domain}/{result.para_type}/{result.subject}*\n"
           f"Category: {result.category}\n"
           f"Confidence: {result.confidence:.0%}\n"
           f"_Reply `fix: domain` to correct_"
       )
       ```

    6. Update the low-confidence message similarly.

    7. Keep the dead letter logging for errors (imports OllamaError handling).
  </action>
  <verify>
    ```bash
    cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend/_scripts
    python -c "
    import sys
    sys.path.insert(0, '.')
    from process_inbox import process_message, get_classifier
    print('get_classifier:', get_classifier)
    print('Module loads OK')
    "
    ```
  </verify>
  <done>process_message() function uses MessageClassifier and create_note_file</done>
</task>

<task type="auto">
  <name>Task 3: Remove deprecated functions</name>
  <files>backend/_scripts/process_inbox.py</files>
  <action>
    Clean up deprecated code:

    1. Remove or comment out these functions (now replaced by file_writer.py):
       - write_to_obsidian() - replaced by create_note_file()
       - log_to_inbox_log() - keep if still useful, or remove if not
       - append_to_daily_note() - keep if still useful, or remove if not

    2. Remove the old CLASSIFICATION_PROMPT constant

    3. Remove the old classify_thought() placeholder function

    4. Update the ValidationError import handling - we no longer use schema.py for classification:
       - Keep schema.py imports only if other parts of the code use them
       - If not used, remove the import

    5. Keep these imports (still needed):
       - slack_client functions
       - state management functions
       - wikilinks (if still used in file_writer)

    Note: Preserve process_all() and main loop - they will be updated in plan 06-03.
  </action>
  <verify>
    ```bash
    cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend/_scripts
    python -c "from process_inbox import process_all; print('Module clean and importable')"
    ```
  </verify>
  <done>Deprecated functions removed, module imports cleanly</done>
</task>

</tasks>

<verification>
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend

# Verify module imports
python -c "from _scripts.process_inbox import process_message, process_all, get_classifier"

# Verify integration with classifier (mocked)
python -c "
from _scripts.message_classifier import MessageClassifier
from _scripts.file_writer import create_note_file
print('Dependencies available')
"
```

Module imports without errors, all dependencies resolved.
</verification>

<success_criteria>
1. process_inbox.py uses MessageClassifier instead of classify_thought()
2. process_inbox.py uses create_note_file() instead of write_to_obsidian()
3. Module imports cleanly without errors
4. Old classification code removed (CLASSIFICATION_PROMPT, classify_thought)
5. Slack reply messages reflect new 4-level classification structure
</success_criteria>

<output>
After completion, create `.planning/phases/06-processing-integration/06-02-SUMMARY.md`
</output>
