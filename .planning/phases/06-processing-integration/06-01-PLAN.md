---
phase: 06-processing-integration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/_scripts/file_writer.py
  - backend/tests/test_file_writer.py
autonomous: true

must_haves:
  truths:
    - "Files are created with YAML frontmatter containing domain, para_type, subject, category"
    - "Files are placed in domain/para_type/subject/ folder hierarchy"
    - "Frontmatter is valid YAML parseable by Obsidian"
    - "Filenames are unique (timestamp-based) and sanitized"
  artifacts:
    - path: "backend/_scripts/file_writer.py"
      provides: "create_note_file function for PARA-aware file creation"
      exports: ["create_note_file", "build_frontmatter", "sanitize_filename"]
      min_lines: 80
    - path: "backend/tests/test_file_writer.py"
      provides: "Unit tests for file writer"
      min_lines: 100
  key_links:
    - from: "backend/_scripts/file_writer.py"
      to: "message_classifier.ClassificationResult"
      via: "import and type hint"
      pattern: "from message_classifier import ClassificationResult"
---

<objective>
Create a file_writer module that generates .md files with proper YAML frontmatter and places them in the correct vault folder path based on classification results.

Purpose: Centralizes file creation logic for the PARA-structured vault, enabling the processing pipeline to create properly formatted Obsidian notes.

Output: file_writer.py with create_note_file(), build_frontmatter(), sanitize_filename() functions, plus comprehensive unit tests.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-processing-integration/06-RESEARCH.md
@backend/_scripts/message_classifier.py
@backend/tests/conftest.py
</context>

<feature>
  <name>PARA-Aware File Writer</name>
  <files>backend/_scripts/file_writer.py, backend/tests/test_file_writer.py</files>
  <behavior>
    create_note_file(classification, message_text, vault_path) -> Path:
      - Input: ClassificationResult, original message text, vault root path
      - Output: Path to created file
      - Behavior:
        - Creates folder: vault_path / domain / para_type / subject / (mkdir parents=True)
        - Generates filename: {timestamp}-{sanitized_message_prefix}.md
        - Writes frontmatter + body
        - Returns created file path

    build_frontmatter(classification, timestamp) -> str:
      - Input: ClassificationResult, ISO timestamp string
      - Output: YAML frontmatter string (including --- delimiters)
      - Fields: domain, para_type, subject, category, confidence, reasoning, created

    sanitize_filename(text, max_length=30) -> str:
      - Input: text string, optional max length
      - Output: kebab-case filename-safe string
      - Removes special chars, replaces spaces with hyphens, lowercases

    Test cases:
      - create_note_file: creates file in correct folder structure
      - create_note_file: file contains valid frontmatter
      - create_note_file: handles existing directories gracefully
      - build_frontmatter: produces valid YAML with all fields
      - build_frontmatter: handles special characters in reasoning (quoting)
      - sanitize_filename: removes special characters
      - sanitize_filename: truncates to max_length
      - sanitize_filename: handles empty/whitespace input
      - integration: classification result produces correct file path and content
  </behavior>
  <implementation>
    Follow patterns from 06-RESEARCH.md Pattern 3 (File Creation with Frontmatter).
    Use pathlib for all path operations.
    Manual YAML generation (no external library).
    Quote frontmatter values containing colons or special characters.
    Timestamp format: %Y%m%d-%H%M%S for filename uniqueness.
  </implementation>
</feature>

<verification>
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
pytest tests/test_file_writer.py -v
```

All tests pass, including:
- Folder structure creation (domain/para_type/subject/)
- Frontmatter format validation
- Filename sanitization edge cases
- Special character handling in frontmatter values
</verification>

<success_criteria>
1. `file_writer.py` created with 80+ lines of documented code
2. `test_file_writer.py` created with 10+ test cases
3. All tests pass
4. Code follows existing codebase patterns (docstrings, type hints)
5. No new dependencies (uses stdlib only)
</success_criteria>

<output>
After completion, create `.planning/phases/06-processing-integration/06-01-SUMMARY.md`
</output>
