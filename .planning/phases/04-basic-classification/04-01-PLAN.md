---
phase: 04-basic-classification
plan: 01
type: tdd
wave: 1
depends_on: ["03-ollama-connection", "02-vault-scanner"]
files_modified:
  - backend/_scripts/domain_classifier.py
  - backend/tests/test_domain_classifier.py
autonomous: true

must_haves:
  truths:
    - "Given a message, app returns valid domain from vault vocabulary"
    - "Classification uses vault domains from VaultScanner"
    - "Invalid/unexpected LLM responses are caught and return 'unknown'"
    - "Classification completes within 30 seconds (cold start) or 5 seconds (warm)"
    - "Confidence score returned with classification"
  artifacts:
    - path: "backend/_scripts/domain_classifier.py"
      provides: "DomainClassifier class for single-level domain classification"
      min_lines: 100
      exports: ["DomainClassifier", "classify_domain", "ClassificationResult"]
    - path: "backend/tests/test_domain_classifier.py"
      provides: "Unit tests for domain classification"
      min_lines: 80
  key_links:
    - from: "backend/_scripts/domain_classifier.py"
      to: "backend/_scripts/ollama_client.py"
      via: "import"
      pattern: "from ollama_client import"
    - from: "backend/_scripts/domain_classifier.py"
      to: "backend/_scripts/vault_scanner.py"
      via: "import"
      pattern: "from vault_scanner import"
---

<objective>
Create a DomainClassifier that uses the local LLM (via OllamaClient) to classify messages into domains discovered by VaultScanner.

Purpose: Prove that local LLM classification works for the simplest case (domain-level only) before adding PARA/subject/category levels in Phase 5.

Output: DomainClassifier with classify(message) → ClassificationResult containing domain, confidence, and reasoning.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-ollama-connection/03-01-SUMMARY.md
@backend/_scripts/ollama_client.py
@backend/_scripts/vault_scanner.py
</context>

<feature>
  <name>DomainClassifier</name>
  <files>
    backend/_scripts/domain_classifier.py
    backend/tests/test_domain_classifier.py
  </files>
  <behavior>
    Classify messages into domains using LLM:

    Input: "Need to review Q4 financials for Just Value properties"
    Output: ClassificationResult(
        domain="Just-Value",
        confidence=0.85,
        reasoning="Financial review for Just Value real estate"
    )

    Available domains come from VaultScanner.get_vocabulary()["domains"]:
    - Personal
    - Just-Value
    - CCBH

    Test cases (TDD - write tests FIRST):

    1. Message about personal tasks → domain="Personal"
    2. Message about Just Value properties → domain="Just-Value"
    3. Message about CCBH work → domain="CCBH"
    4. Ambiguous message → returns domain with lower confidence
    5. LLM returns unexpected domain → returns "unknown"
    6. LLM returns valid domain with typo → normalizes to vocab
    7. Empty message → returns "unknown" with error
    8. OllamaServerNotRunning → raises or returns graceful error
    9. OllamaTimeout → raises or returns graceful error
    10. Confidence score between 0.0 and 1.0
    11. Reasoning explains the classification
    12. Uses vault vocabulary in prompt (not hardcoded)
  </behavior>
  <implementation>
    Create domain_classifier.py with:

    1. ClassificationResult dataclass:
       - domain: str
       - confidence: float (0.0-1.0)
       - reasoning: str
       - raw_response: Optional[str]

    2. DomainClassifier class:
       - __init__(ollama_client, vault_scanner)
       - classify(message: str) -> ClassificationResult
       - _build_prompt(message: str, domains: list) -> str
       - _parse_response(response: str, valid_domains: list) -> ClassificationResult

    3. Prompt template:
       ```
       You are a classification assistant. Classify the following message into ONE of these domains:
       {domains}

       Message: {message}

       Respond in JSON format:
       {"domain": "<domain>", "confidence": <0.0-1.0>, "reasoning": "<brief explanation>"}
       
       IMPORTANT: Only use domains from the list above. If unsure, use lower confidence.
       ```

    4. Response parsing:
       - Try JSON parse first
       - Fallback to regex extraction
       - Validate domain against vocabulary
       - Normalize domain name (case-insensitive match)

    5. Convenience function:
       - classify_domain(message: str) -> ClassificationResult
         Uses default clients (get_ollama_client, VaultScanner)

    Handle all OllamaClient exceptions gracefully.
  </implementation>
</feature>

<verification>
Run tests with verbose output:
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run pytest tests/test_domain_classifier.py -v --tb=short
```

Manual verification (requires Ollama running):
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run python -c "
from domain_classifier import classify_domain

# Test personal message
result = classify_domain('Need to set up my home office')
print(f'Personal: {result.domain} ({result.confidence:.0%})')

# Test Just-Value message
result = classify_domain('Review Q4 rental income for Newark properties')
print(f'Just-Value: {result.domain} ({result.confidence:.0%})')

# Test CCBH message
result = classify_domain('Schedule meeting with CCBH board members')
print(f'CCBH: {result.domain} ({result.confidence:.0%})')
"
```
</verification>

<success_criteria>
1. Tests written FIRST, fail initially (RED phase)
2. DomainClassifier.classify() returns valid ClassificationResult
3. Domain is from vault vocabulary or "unknown"
4. Confidence between 0.0 and 1.0
5. Reasoning explains classification
6. Handles LLM errors gracefully
7. At least 12 test cases covering classification and error handling
8. `uv run pytest tests/test_domain_classifier.py -v` exits with code 0
</success_criteria>

<output>
After completion, create `.planning/phases/04-basic-classification/04-01-SUMMARY.md`
</output>
