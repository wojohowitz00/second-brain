---
phase: 02.5-task-management
plan: 01
type: tdd
wave: 1
depends_on: ["02-vault-scanner"]
files_modified:
  - backend/_scripts/task_parser.py
  - backend/_scripts/process_inbox.py
  - backend/_scripts/status_handler.py
  - backend/tests/test_task_parser.py
autonomous: true

must_haves:
  truths:
    - "Tasks route into domain/PARA/subject folders based on parsed indicators"
    - "Task frontmatter includes type, status, priority, project, domain fields"
    - "Slack prefixes todo: and kanban: create unified task type"
    - "Status transitions via !done, !progress, !blocked, !backlog Slack replies"
    - "Dataview queries can filter type:task across entire vault"
  artifacts:
    - path: "backend/_scripts/task_parser.py"
      provides: "parse_task_indicators() function for Slack message parsing"
      min_lines: 60
      exports: ["parse_task_indicators", "PRIORITY_MAP", "STATUS_COMMANDS"]
    - path: "backend/_scripts/status_handler.py"
      provides: "Status transition handler for Slack thread replies"
      min_lines: 40
      exports: ["process_status_command", "update_status_in_file"]
    - path: "backend/tests/test_task_parser.py"
      provides: "Unit tests for task parsing"
      min_lines: 80
  key_links:
    - from: "backend/_scripts/process_inbox.py"
      to: "backend/_scripts/task_parser.py"
      via: "import"
      pattern: "from task_parser import"
---

<objective>
Add task management to Second Brain by parsing Slack messages with task indicators (todo:, kanban:, domain:, project:, priority) and routing them into the existing domain/PARA/subject folder structure.

Purpose: Enable Kanban/Todo workflow via Slack capture, with tasks appearing in correct vault locations and visible in Dataview dashboards.

Output: Task files in vault with proper frontmatter, status changeable via Slack replies.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-vault-scanner/02-01-PLAN.md
@backend/_scripts/process_inbox.py
@backend/_scripts/fix_handler.py
@backend/tests/conftest.py
</context>

<feature>
  <name>Task Parser</name>
  <files>
    backend/_scripts/task_parser.py
    backend/tests/test_task_parser.py
  </files>
  <behavior>
    Parse Slack messages for task indicators:
    
    Input: "todo: Create RVM dashboard domain:just-value project:rvm p1"
    Output: {
        "is_task": True,
        "view": "todo",
        "domain": "Just-Value",
        "project": "rvm",
        "priority": "high",
        "clean_text": "Create RVM dashboard"
    }

    Test cases (TDD - write tests FIRST):

    1. todo: prefix → is_task=True, view="todo"
    2. kanban: prefix → is_task=True, view="kanban"
    3. No task prefix → is_task=False
    4. domain:just-value → domain="Just-Value"
    5. domain:personal → domain="Personal"
    6. domain:ccbh → domain="CCBH"
    7. project:rvm → project="rvm"
    8. p1 → priority="high"
    9. p2 → priority="medium"
    10. p3 → priority="low"
    11. No priority → priority="medium" (default)
    12. Combined indicators → all parsed, clean_text has content only
    13. Status commands: !done, !progress, !blocked, !backlog
  </behavior>
  <implementation>
    Create task_parser.py with:

    1. parse_task_indicators(text: str) -> dict:
       - Detect todo:/kanban: prefix
       - Parse domain: indicator (normalize: just-value → Just-Value)
       - Parse project: indicator
       - Parse priority (p1/p2/p3)
       - Strip all indicators from text to get clean_text
       - Return metadata dict

    2. Constants:
       - PRIORITY_MAP = {"p1": "high", "p2": "medium", "p3": "low"}
       - STATUS_COMMANDS = ["!done", "!progress", "!blocked", "!backlog"]
       - DOMAIN_ALIASES = {"just-value": "Just-Value", "justvalue": "Just-Value", ...}

    Use re module for pattern matching.
    Lowercase-normalize before matching.
    Case-preserve clean_text.
  </implementation>
</feature>

<feature>
  <name>Task Routing Integration</name>
  <files>
    backend/_scripts/process_inbox.py
  </files>
  <behavior>
    Modify process_inbox.py to use task_parser and route tasks to vault:

    1. Before classification, call parse_task_indicators()
    2. If is_task=True:
       - Set destination based on domain/project
       - Use vault scanner vocabulary to validate paths
       - Build file path: {domain}/{PARA}/{subject}/{slug}.md
       - Use 1_Projects as default PARA for tasks
       - Fallback to Slack-Captured folder if project not found
    3. Write task frontmatter:
       - type: task
       - task: {clean_text}
       - domain: {domain}
       - para: 1_Projects
       - project: {project}
       - status: backlog
       - priority: {priority}
       - created: {date}
  </behavior>
</feature>

<feature>
  <name>Status Handler</name>
  <files>
    backend/_scripts/status_handler.py
    backend/tests/test_status_handler.py
  </files>
  <behavior>
    Handle status transitions via Slack thread replies:

    Input: "!done" reply to task message
    Output: Update task file frontmatter, reply with confirmation

    Commands:
    - !done → status: done
    - !progress → status: in_progress
    - !blocked → status: blocked
    - !backlog → status: backlog

    Follow fix_handler.py pattern:
    1. Detect ! prefix in thread reply
    2. Look up file from message→file mapping (state.py)
    3. Read file, update YAML frontmatter status field
    4. Write file back
    5. Reply in thread with confirmation
  </behavior>
</feature>

<verification>
Run tests with verbose output:
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run pytest tests/test_task_parser.py tests/test_status_handler.py -v --tb=short
```

Manual end-to-end test:
1. Send to Slack: "todo: Test task domain:personal p1"
2. Verify file created in Personal/1_Projects/Slack-Captured/
3. Reply "!done" to task message
4. Verify frontmatter updated to status: done
</verification>

<success_criteria>
1. Tests written FIRST, fail initially (RED phase)
2. parse_task_indicators() parses all indicator types correctly
3. Tasks route to correct domain/PARA folder in vault
4. Task frontmatter includes all required fields
5. Status commands update file frontmatter correctly
6. At least 15 test cases covering parsing and status updates
7. `uv run pytest tests/test_task_parser.py -v` exits with code 0
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-task-management/02.5-01-SUMMARY.md`
</output>
