---
phase: 08-first-run-wizard
plan: 01
type: implementation
wave: 1
depends_on: ["07-menu-bar-interface"]
files_modified:
  - backend/_scripts/setup_wizard.py
  - backend/tests/test_setup_wizard.py
autonomous: true

must_haves:
  truths:
    - "Wizard detects if Ollama is installed"
    - "Wizard guides Ollama download if missing"
    - "Wizard checks if required model is available"
    - "Wizard triggers model download with progress"
    - "Wizard allows vault path configuration"
    - "Wizard validates Slack credentials"
  artifacts:
    - path: "backend/_scripts/setup_wizard.py"
      provides: "SetupWizard class with step-by-step first-run flow"
      min_lines: 200
      exports: ["SetupWizard", "run_setup_wizard", "SetupStep"]
    - path: "backend/tests/test_setup_wizard.py"
      provides: "Unit tests for setup wizard"
      min_lines: 100
---

<objective>
Create a first-run setup wizard that guides new users through Ollama installation, model download, vault configuration, and Slack credential validation.

Purpose: Enable non-technical users to complete Second Brain setup without CLI knowledge or documentation reading.

Output: SetupWizard with step-based UI flow, integrating with MenuBarApp on completion.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@backend/_scripts/ollama_client.py
@backend/_scripts/vault_scanner.py
@backend/_scripts/menu_bar_app.py
</context>

<feature>
  <name>SetupWizard</name>
  <files>
    backend/_scripts/setup_wizard.py
    backend/tests/test_setup_wizard.py
  </files>
  <behavior>
    Step-by-step wizard for first-run setup:

    **Step 1: Welcome**
    - Show app description
    - Explain what will be configured

    **Step 2: Ollama Check**
    - Check if Ollama is installed (ollama --version)
    - If missing: show download link, wait for installation
    - Verify Ollama server can start

    **Step 3: Model Download**
    - Check if llama3.2:latest is available
    - If missing: trigger `ollama pull llama3.2:latest`
    - Show download progress
    - Verify model responds

    **Step 4: Vault Configuration**
    - Show current vault path (from config or default)
    - Allow user to browse/select different path
    - Validate path is valid Obsidian vault (has .obsidian/)
    - Scan and show discovered domains

    **Step 5: Slack Credentials**
    - Check if credentials exist in .env
    - If missing: prompt for Bot Token and App Token
    - Validate credentials by calling Slack API
    - Show connected workspace name

    **Step 6: Complete**
    - Show summary of configuration
    - Start menu bar app

    Test cases (TDD - write tests FIRST):
    1. is_ollama_installed() returns True when installed
    2. is_ollama_installed() returns False when missing
    3. is_model_available() checks model list
    4. download_model() starts pull and reports progress
    5. validate_vault_path() returns True for valid vault
    6. validate_vault_path() returns False for missing .obsidian
    7. validate_slack_credentials() tests API connection
    8. get_current_step() returns correct step
    9. advance_step() moves to next step
    10. can_advance() checks step prerequisites
    11. run() executes all steps in order
    12. skip_if_complete() skips already-done steps
  </behavior>
  <implementation>
    Create setup_wizard.py with:

    1. SetupStep enum:
       - WELCOME, OLLAMA_CHECK, MODEL_DOWNLOAD
       - VAULT_CONFIG, SLACK_CREDENTIALS, COMPLETE

    2. SetupWizard class:
       - __init__(config_path) - Load/create config
       - current_step -> SetupStep
       - is_step_complete(step) -> bool
       - run_step(step) -> StepResult
       - advance() -> bool
       - run() -> bool (full wizard)

    3. Step implementations:
       - check_ollama() -> dict
       - download_model(callback) -> bool
       - configure_vault(path) -> bool
       - validate_slack(token) -> dict

    4. UI (using rumps dialogs or terminal):
       - show_message(title, body)
       - show_progress(percent, message)
       - ask_path() -> str
       - ask_input(label) -> str

    5. Persistence:
       - Save completed steps to .state/setup_state.json
       - Resume from last incomplete step

    Use subprocess for Ollama commands.
    Use httpx for Slack API validation.
  </implementation>
</feature>

<verification>
Run tests with verbose output:
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run pytest tests/test_setup_wizard.py -v --tb=short
```

Manual verification:
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run python -c "
from setup_wizard import SetupWizard

wizard = SetupWizard()
print(f'Ollama installed: {wizard.is_ollama_installed()}')
print(f'Model available: {wizard.is_model_available()}')
print(f'Current step: {wizard.current_step}')
"
```
</verification>

<success_criteria>
1. Tests written FIRST, fail initially (RED phase)
2. Wizard detects Ollama installation status
3. Wizard can trigger model download
4. Wizard validates vault path
5. Wizard validates Slack credentials
6. Wizard saves state and can resume
7. At least 12 test cases
8. `uv run pytest tests/test_setup_wizard.py -v` exits with code 0
</success_criteria>

<output>
After completion, create `.planning/phases/08-first-run-wizard/08-01-SUMMARY.md`
</output>
