---
phase: 02-vault-scanner
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/_scripts/vault_scanner.py
  - backend/tests/test_vault_scanner.py
autonomous: true

must_haves:
  truths:
    - "Scanner discovers domain folders from vault root"
    - "Scanner discovers PARA subfolders within each domain"
    - "Scanner discovers subject folders within each PARA section"
    - "Scanner skips hidden files and symlinks"
    - "Scanner handles missing/inaccessible directories gracefully"
  artifacts:
    - path: "backend/_scripts/vault_scanner.py"
      provides: "VaultScanner class with scan method"
      min_lines: 80
      exports: ["VaultScanner", "scan_vault_structure"]
    - path: "backend/tests/test_vault_scanner.py"
      provides: "Unit tests for vault scanning"
      min_lines: 100
  key_links:
    - from: "backend/tests/test_vault_scanner.py"
      to: "backend/_scripts/vault_scanner.py"
      via: "import"
      pattern: "from vault_scanner import"
---

<objective>
Build the core vault scanner that discovers the three-level hierarchy (domain -> PARA -> subject) from the Obsidian vault filesystem.

Purpose: This is the foundation for classification vocabulary. The scanner provides the "words" (domain names, PARA types, subjects) that the LLM will use to classify messages in later phases.

Output: VaultScanner class that scans ~/PARA and returns structured dictionary of domains, PARA folders, and subjects.
</objective>

<execution_context>
@/Users/richardyu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardyu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-vault-scanner/02-RESEARCH.md
@backend/_scripts/state.py
@backend/tests/conftest.py
</context>

<feature>
  <name>Vault Scanner Core</name>
  <files>
    backend/_scripts/vault_scanner.py
    backend/tests/test_vault_scanner.py
  </files>
  <behavior>
    Given a vault path, return three-level structure:

    Input: Path("/Users/richardyu/PARA")
    Output: {
        "Personal": {
            "1_Projects": ["apps", "writing"],
            "2_Areas": ["health", "finance"],
            "3_Resources": [],
            "4_Archive": ["old-stuff"]
        },
        "CCBH": {
            "2_Areas": ["clients", "admin"]
        },
        "Just Value": {
            "1_Projects": ["mvp"]
        }
    }

    Test cases (TDD - write tests FIRST):

    1. Empty vault -> returns empty dict {}
    2. Single domain, no PARA folders -> {"Personal": {}}
    3. Domain with PARA, no subjects -> {"Personal": {"1_Projects": []}}
    4. Full three-level structure -> nested dict as shown above
    5. Hidden files (.DS_Store) at any level -> skipped
    6. Symlinks -> skipped (avoid loops)
    7. Permission denied directory -> skipped with warning, continues scanning
    8. Non-existent vault path -> raises FileNotFoundError
    9. File (not directory) at domain level -> skipped
    10. Mixed content (files + folders at each level) -> only folders included
  </behavior>
  <implementation>
    Create vault_scanner.py with:

    1. VaultScanner class:
       - __init__(vault_path: Path = VAULT_ROOT) - configurable vault path
       - scan() -> Dict[str, Dict[str, List[str]]] - core scan method
       - _safe_iterdir(path: Path) -> Iterator[Path] - helper to filter hidden/symlinks

    2. Module constants:
       - VAULT_ROOT = Path.home() / "PARA"

    3. Convenience function:
       - scan_vault_structure(vault_path: Path = VAULT_ROOT) -> Dict

    Use pathlib.iterdir() for controlled traversal (not rglob).
    Skip entries starting with "." at every level.
    Skip symlinks using is_symlink() check.
    Wrap iterdir() in try/except for PermissionError.
    Sort subject lists for deterministic output.
  </implementation>
</feature>

<verification>
Run tests with verbose output:
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run pytest tests/test_vault_scanner.py -v --tb=short
```

Verify against real vault (manual check):
```bash
cd /Users/richardyu/PARA/Personal/1_Projects/apps/second-brain/backend
uv run python -c "from vault_scanner import scan_vault_structure; import json; print(json.dumps(scan_vault_structure(), indent=2))"
```

Expected: Returns actual structure from ~/PARA with Personal, CCBH, Just Value domains.
</verification>

<success_criteria>
1. Tests written FIRST, fail initially (RED phase)
2. VaultScanner.scan() returns correct nested structure
3. Hidden files and symlinks are filtered at all levels
4. Permission errors don't crash scanner
5. At least 10 test cases covering happy path and edge cases
6. Tests use tmp_path fixture (no real vault access in tests)
7. `uv run pytest tests/test_vault_scanner.py -v` exits with code 0
</success_criteria>

<output>
After completion, create `.planning/phases/02-vault-scanner/02-01-SUMMARY.md`
</output>
